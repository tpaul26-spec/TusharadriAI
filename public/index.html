<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>P2P Chat (Render)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
      body { font: 16px/1.4 system-ui, sans-serif; margin: 0; background:#0b0f14; color:#e8e8e8; }
      .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
      .card { background:#121823; border:1px solid #1e2633; border-radius: 14px; padding: 16px; }
      input, button { padding: 10px 12px; border-radius: 10px; border:1px solid #2a3444; background:#0e1420; color:#e8e8e8; }
      input { width: 100%; }
      .row { display: grid; grid-template-columns: 1fr 120px; gap: 8px; }
      .msgs { height: 50vh; overflow: auto; margin: 12px 0; padding-right: 6px; }
      .msg { margin: 6px 0; }
      .me { text-align: right; }
      .sys { color:#8aa0b3; font-style: italic; }
      .pill { font-size: 12px; background:#1a2533; padding:2px 8px; border-radius:999px; display:inline-block; margin-left:8px; }
      .header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="header">
          <h3 style="margin:0">P2P Chat</h3>
          <span class="pill" id="status">disconnected</span>
        </div>

        <div id="join">
          <p>Apna <b>name</b> aur ek shared <b>Room ID</b> daalo (e.g. <code>tushar-123</code>). Jis room ID ko dono choose karenge, wahi private chat hai.</p>
          <div class="row" style="grid-template-columns:1fr 1fr;">
            <input id="name" placeholder="Your name"/>
            <input id="room" placeholder="Room ID"/>
          </div>
          <div style="margin-top:8px">
            <button id="btnJoin">Join</button>
          </div>
        </div>

        <div id="chat" style="display:none">
          <div class="row" style="grid-template-columns:1fr auto;">
            <input id="roomView" disabled/>
            <button id="btnLeave">Leave</button>
          </div>
          <div class="msgs" id="msgs"></div>
          <div class="row">
            <input id="text" placeholder="Type message & press Enter"/>
            <button id="send">Send</button>
          </div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const $ = (id) => document.getElementById(id);
      const msgs = $("msgs");
      const status = $("status");
      const nameInput = $("name");
      const roomInput = $("room");
      const roomView = $("roomView");
      const join = $("join");
      const chat = $("chat");
      const text = $("text");

      let socket = null;
      let state = { name: localStorage.getItem("name") || "", room: localStorage.getItem("room") || "" };
      if (state.name) nameInput.value = state.name;
      if (state.room) roomInput.value = state.room;

      function addMsg(html, cls="") {
        const div = document.createElement("div");
        div.className = `msg ${cls}`;
        div.innerHTML = html;
        msgs.appendChild(div);
        msgs.scrollTop = msgs.scrollHeight;
      }

      function connect() {
        socket = io(); // same origin
        status.textContent = "connecting...";
        socket.on("connect", () => {
          status.textContent = "connected";
          socket.emit("join", { roomId: state.room, name: state.name });
          roomView.value = state.room;
        });
        socket.on("disconnect", () => status.textContent = "disconnected");

        socket.on("system", (m) => addMsg(m, "sys"));
        socket.on("message", ({ from, text, ts }) => {
          const mine = from === state.name;
          const time = new Date(ts).toLocaleTimeString();
          addMsg(`<b>${from}</b>: ${text} <span class="pill">${time}</span>`, mine ? "me" : "");
        });
      }

      $("btnJoin").onclick = () => {
        const name = nameInput.value.trim();
        const room = roomInput.value.trim();
        if (!name || !room) return alert("Name aur Room ID dono chahiye.");

        state = { name, room };
        localStorage.setItem("name", name);
        localStorage.setItem("room", room);

        join.style.display = "none";
        chat.style.display = "";
        addMsg(`Joined room <b>${room}</b> as <b>${name}</b>`, "sys");
        connect();
        text.focus();
      };

      $("btnLeave").onclick = () => {
        if (socket) socket.disconnect();
        chat.style.display = "none";
        join.style.display = "";
        status.textContent = "disconnected";
        msgs.innerHTML = "";
      };

      $("send").onclick = sendNow;
      text.addEventListener("keydown", (e) => { if (e.key === "Enter") sendNow(); });

      function sendNow() {
        const t = text.value.trim();
        if (!t) return;
        socket.emit("message", { roomId: state.room, text: t });
        text.value = "";
        text.focus();
      }
    </script>
  </body>
</html>
